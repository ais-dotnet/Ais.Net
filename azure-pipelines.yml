trigger:
  branches:
    include:
    - master
    - feature/*
  tags:
    include:
    - '*'

resources:
  repositories:
    - repository: recommended_practices
      type: github
      name: endjin/Endjin.RecommendedPractices.AzureDevopsPipelines.GitHub
      endpoint: ais-dotnet-github

jobs:
- template: templates/build.and.release.yml@recommended_practices
  parameters:
    vmImage: 'ubuntu-latest'
    service_connection_nuget_org: $(Endjin_Service_Connection_NuGet_Org)
    service_connection_github: $(Endjin_Service_Connection_GitHub)
    solution_to_build: $(Endjin_Solution_To_Build)

- job: Benchmark
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'Restore & Build'
    inputs:
      command: 'build'
      projects: $(Endjin_Solution_To_Build)
      arguments: '--configuration Release'
  - task: DotNetCoreCLI@2
    displayName: 'Run benchmarks'
    inputs:
      command: 'run'
      projects: $(Build.SourcesDirectory)/Solutions/Ais.Net.Benchmarks/Ais.Net.Benchmarks.csproj
      arguments: '--configuration Release --no-build'
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: Benchmark'
    inputs:
      PathtoPublish: '$(Build.SourcesDirectory)/Solutions/Ais.Net.Benchmarks/bin/Release/netcoreapp2.2/BenchmarkDotNet.Artifacts/results'